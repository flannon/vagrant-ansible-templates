---
# tasks file for openshift-control---
- name: upgrade all packages
  yum: 
    name: '*'
    state: latest

- name: Check for reboot status
  #shell: LAST_KERNEL=$(rpm -q --last kernel | awk 'NR==1{sub(/kernel-/,""); print $1}'); CURRENT_KERNEL=$(uname -r); if [ $LAST_KERNEL != $CURRENT_KERNEL ]; then echo 'reboot'; else echo 'no'; fi
  shell: | 
    if [ $(rpm -q kernel|tail -n 1) != kernel-$(uname -r) ]; then 
      echo 'reboot' 
    else 
      echo 'no' 
    fi
  ignore_errors: true
  args:
    executable: /bin/bash
  register: reboot_status

- name: "Rebooting"
  command: shutdown -r now "Reboot required for kernel update"
  async: 0
  poll: 0
  when: reboot_status.stdout.find("reboot") != -1
  register: result

- name: Waiting for reboot to complete
  #pause: seconds=45
  local_action: wait_for host={{ ansible_ssh_host | default(inventory_hostname) }} state=started port=22 delay=30 timeout=300 connect_timeout=15
  when: result is changed

